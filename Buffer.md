# BR 結構

## 模塊結構
BR是一個典型的JS與C++結合的模塊，性能部分用C++實現，非性能部分用JS實現。因爲屬於核心模塊，所以NS在進程啓動的時候就已經加載好了，所以無需引入直接使用。
上次說過因爲BR屬於非V8分配的堆外内存，所以非常適用於大多數場景下的大内存操作。

## BR對象
BR對象類似數組，它的元素為16進制的兩位數，即0~255的數值。
```
var str = "Buffer對象。",
    buf = new Buffer(str, 'utf-8');
console.log(buf);
//<Buffer 42 75 66 66 65 72 e5 b0 8d e8 b1 a1 e3 80 82>
```

之所以說BR對象和數組很像是因爲它們實例化方式，訪問length長度和下標訪問賦值元素都一樣。
```
var buf = new Buffer(100);
console.log(buf.length); //100
console.log(buf[0]); //0
buf[0] = 100;
console.log(buf[0]); //100
```

注意：如果賦值非整數則捨棄小數，小於 0 會逐次加 256 ，大於 255 則逐次減 256。
```
var buf = new Buffer(100);
buf[0] = 100.01;
buf[1] = -100;
buf[2] = 300;
console.log(buf[0], buf[1], buf[2]); //100 156 44
```


## BR内存分配
BR對象的内存分配是在NS的C++層面實現内存申請的，因爲處理大量的字節數據不能采用需要多少就像操作系統申請多少的方式，這可能造成大量的内存申請的系統調用，對操作系統有一定壓力。因此NS采用C++層面申請内存，JS中分配内存的策略。
